<!DOCTYPE html>
<html lang="{{ language or 'en' }}">
<head>
    <meta charset="UTF-8">
    <title>ScooterMania Financing Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <style>
        body {
            background-color: {% if theme == 'light' %}#f5f5f5{% else %}#111{% endif %};
            color: {% if theme == 'light' %}#222{% else %}#f5f5f5{% endif %};
        }
        .card {
            background-color: {% if theme == 'light' %}#ffffff{% else %}#1e1e1e{% endif %};
            border-radius: 12px;
            border: 1px solid {% if theme == 'light' %}#ddd{% else %}#333{% endif %};
            margin-bottom: 20px;
        }
        label {
            font-weight: 600;
        }
        .logo {
            max-width: 180px;
            display: block;
            margin: 20px auto 10px auto;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 20px;
            border-bottom: 1px solid {% if theme == 'light' %}#ccc{% else %}#444{% endif %};
            padding-bottom: 5px;
        }
        .result-row {
            margin-bottom: 4px;
        }
        input[readonly] {
            background-color: {% if theme == 'light' %}#eee{% else %}#333{% endif %};
        }
        .small-note {
            font-size: 0.85rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div class="container py-3">

    <!-- LOGO (make sure /static/logo.png exists) -->
    <img src="{{ url_for('static', filename='logo.png') }}" alt="ScooterMania" class="logo">

    <!-- LANGUAGE & THEME -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <form method="get" class="d-flex align-items-center gap-2">
            <div>
                <label class="form-label mb-0">
                    {% if language == 'es' %}Idioma{% else %}Language{% endif %}
                </label>
                <select name="language" class="form-select form-select-sm"
                        onchange="this.form.submit()">
                    <option value="en" {% if language == 'en' %}selected{% endif %}>English</option>
                    <option value="es" {% if language == 'es' %}selected{% endif %}>Español</option>
                </select>
            </div>

            <div>
                <label class="form-label mb-0">
                    {% if language == 'es' %}Tema{% else %}Theme{% endif %}
                </label>
                <select name="theme" class="form-select form-select-sm"
                        onchange="this.form.submit()">
                    <option value="dark" {% if theme == 'dark' %}selected{% endif %}>
                        {% if language == 'es' %}Oscuro{% else %}Dark{% endif %}
                    </option>
                    <option value="light" {% if theme == 'light' %}selected{% endif %}>
                        {% if language == 'es' %}Claro{% else %}Light{% endif %}
                    </option>
                </select>
            </div>
        </form>
    </div>

    <!-- MAIN CARD -->
    <div class="card p-3">
        <form method="post" novalidate>
            <input type="hidden" name="language" value="{{ language }}">
            <input type="hidden" name="theme" value="{{ theme }}">

            <!-- TOTAL PRICE -->
            <div class="mb-3">
                <label class="form-label">
                    {% if language == 'es' %}
                        Precio total al cliente (incluye impuestos + envío):
                    {% else %}
                        Total price to customer (includes tax + shipping):
                    {% endif %}
                </label>
                <input type="number"
                       class="form-control"
                       name="total_price"
                       step="0.01"
                       value="{{ form.total_price }}">
            </div>

            <!-- SHIPPING TOGGLE (fixed 900, non-editable) -->
            <div class="mb-2 form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="include_shipping"
                       name="include_shipping"
                       {% if form.include_shipping %}checked{% endif %}>
                <label class="form-check-label" for="include_shipping">
                    {% if language == 'es' %}
                        Incluir envío fijo de ${{ '%.2f'|format(shipping_amount) }} (no gravado, no ingreso)
                    {% else %}
                        Include fixed shipping ${{ '%.2f'|format(shipping_amount) }} (not taxed, not revenue)
                    {% endif %}
                </label>
            </div>

            <!-- TAX RATE DISPLAY (locked 7%) -->
            <div class="mb-3">
                <label class="form-label">
                    {% if language == 'es' %}
                        Impuesto estatal (fijo):
                    {% else %}
                        State tax (fixed):
                    {% endif %}
                </label>
                <input type="text"
                       class="form-control"
                       value="{{ tax_rate_percent }}%"
                       readonly>
                <div class="small-note">
                    {% if language == 'es' %}
                        Fijado a 7%. No se puede cambiar.
                    {% else %}
                        Locked at 7%. Cannot be changed.
                    {% endif %}
                </div>
            </div>

            <!-- BIKE COST -->
            <div class="mb-3">
                <label class="form-label">
                    {% if language == 'es' %}
                        Costo de la moto para la tienda:
                    {% else %}
                        Bike cost to store:
                    {% endif %}
                </label>
                <input type="number"
                       class="form-control"
                       name="bike_cost"
                       step="0.01"
                       value="{{ form.bike_cost }}">
            </div>

            <!-- SELLER COMMISSION (we still keep it for future use or other cases) -->
            <div class="mb-3">
                <label class="form-label">
                    {% if language == 'es' %}
                        Comisión para el vendedor (opcional):
                    {% else %}
                        Seller commission (optional):
                    {% endif %}
                </label>
                <input type="number"
                       class="form-control"
                       name="seller_commission"
                       step="0.01"
                       value="{{ form.seller_commission }}">
            </div>

            <!-- BANK SECTION -->
            <h5 class="section-title">
                {% if language == 'es' %}
                    Bancos y montos financiados
                {% else %}
                    Financing companies & financed amounts
                {% endif %}
            </h5>

            <p class="small-note">
                {% if language == 'es' %}
                    Ingrese cuánto financia cada banco para este negocio y, si aplica,
                    seleccione el porcentaje de comisión (merchant fee).
                {% else %}
                    Enter how much each bank is financing for this deal and, if applicable,
                    select the merchant fee % for that bank.
                {% endif %}
            </p>

            <div class="row">
                {% for key, bank in banks.items() %}
                    {% set name_en, name_es, rates = bank %}
                    <div class="col-12 col-md-6 mb-3">
                        <div class="border rounded p-2">
                            <div class="mb-1 fw-bold">
                                {{ name_es if language == 'es' else name_en }}
                            </div>
                            <label class="form-label mb-1">
                                {% if language == 'es' %}Monto financiado{% else %}Amount financed{% endif %}
                            </label>
                            <input type="number"
                                   class="form-control mb-2"
                                   name="{{ key }}_amount"
                                   step="0.01"
                                   value="{{ bank_form[key].amount }}">

                            <label class="form-label mb-1">
                                {% if language == 'es' %}Porcentaje de comisión{% else %}Merchant fee %{% endif %}
                            </label>

                            {% if rates|length > 1 %}
                                <select class="form-select"
                                        name="{{ key }}_rate">
                                    {% for r in rates %}
                                        <option value="{{ r }}"
                                          {% if bank_form[key].rate == r %}selected{% endif %}>
                                            {{ r }}%
                                        </option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                <input type="number"
                                       class="form-control"
                                       name="{{ key }}_rate"
                                       step="0.01"
                                       value="{{ bank_form[key].rate }}"
                                       {% if rates|length == 1 %}readonly{% endif %}>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- BUTTONS -->
            <div class="d-grid gap-2 mt-3">
                <button type="submit" class="btn btn-primary">
                    {% if language == 'es' %}Calcular{% else %}Calculate{% endif %}
                </button>
            </div>
        </form>
    </div>

    <!-- RESULTS CARD -->
    {% if results %}
    <div class="card p-3">

        <h4>{{ results.labels.results_title }}</h4>

        <div class="section-title">
            {% if language == 'es' %}Resumen de precios{% else %}Price breakdown{% endif %}
        </div>

        <div class="result-row">
            <strong>{{ results.labels.bike_before_tax }}</strong>
            ${{ '%.2f'|format(results.bike_before_tax) }}
        </div>
        <div class="result-row">
            <strong>{{ results.labels.tax_amount }}</strong>
            ${{ '%.2f'|format(results.tax_amount) }}
        </div>
        <div class="result-row">
            <strong>{{ results.labels.subtotal_no_shipping }}</strong>
            ${{ '%.2f'|format(results.subtotal_no_shipping) }}
        </div>
        <div class="result-row">
            <strong>{{ results.labels.shipping }}</strong>
            ${{ '%.2f'|format(results.shipping) }}
        </div>
        <div class="result-row">
            <strong>{{ results.labels.gross_income }}</strong>
            ${{ '%.2f'|format(results.gross_income) }}
        </div>
        <div class="result-row">
            <strong>{{ results.labels.total_bank }}</strong>
            ${{ '%.2f'|format(results.total_bank_fees) }}
        </div>

        <div class="section-title">
            {{ results.labels.bank_breakdown_title }}
        </div>
        <ul class="mb-3">
            {% for b in results.bank_results %}
                {% if b.amount > 0 %}
                    <li>
                        {{ b.name_es if language == 'es' else b.name_en }}:
                        ${{ '%.2f'|format(b.amount) }}
                        × {{ '%.2f'|format(b.rate) }}% =
                        ${{ '%.2f'|format(b.fee) }}
                    </li>
                {% endif %}
            {% endfor %}
        </ul>

        <!-- CASE 1: NO PASAS COMISIÓN DEL BANCO -->
        <div class="section-title">
            {{ results.labels.no_pass_net }}
        </div>
        <div class="result-row">
            <strong>
                {% if language == 'es' %}
                    Neto a la tienda (NO pasas comisión del banco):
                {% else %}
                    Net to store (DO NOT pass bank fees):
                {% endif %}
            </strong>
            ${{ '%.2f'|format(results.net_no_pass) }}
        </div>
        <div class="result-row">
            <strong>{{ results.labels.no_pass_profit }}</strong>
            ${{ '%.2f'|format(results.profit_no_pass) }}
        </div>

        <!-- CASE 2: SI PASAS COMISIÓN DEL BANCO -->
        <div class="section-title">
            {{ results.labels.pass_price }}
        </div>

        <div class="result-row">
            <strong>
                {% if language == 'es' %}
                    Precio al cliente (incluyendo comisiones del banco):
                {% else %}
                    Customer price (including bank fees):
                {% endif %}
            </strong>
            ${{ '%.2f'|format(results.customer_price_with_fees) }}
        </div>

        <div class="result-row">
            <strong>{{ results.labels.pass_net }}</strong>
            ${{ '%.2f'|format(results.net_with_pass) }}
        </div>

        <!-- COMMISSION WHEN FEES ARE PASSED -->
        {% set commission_pass = results.profit_with_pass %}
        {% set commission_store = commission_pass / 2 %}
        {% set commission_seller = commission_pass / 2 %}

        <div class="section-title">
            {% if language == 'es' %}
                Si Pasas Comisión Del Banco – Comisión
            {% else %}
                If You PASS Bank Fees – Commission
            {% endif %}
        </div>

        <div class="result-row">
            <strong>
                {% if language == 'es' %}
                    Comisión total (después de costo, sin contar envío):
                {% else %}
                    Total commission (after cost, shipping excluded):
                {% endif %}
            </strong>
            ${{ '%.2f'|format(commission_pass) }}
        </div>

        <div class="result-row">
            <strong>
                {% if language == 'es' %}
                    Comisión para la tienda:
                {% else %}
                    Commission for the store:
                {% endif %}
            </strong>
            ${{ '%.2f'|format(commission_store) }}
        </div>

        <div class="result-row">
            <strong>
                {% if language == 'es' %}
                    Comisión para el vendedor:
                {% else %}
                    Commission for the seller:
                {% endif %}
            </strong>
            ${{ '%.2f'|format(commission_seller) }}
        </div>

    </div>
    {% endif %}

</div>

</body>
</html>
